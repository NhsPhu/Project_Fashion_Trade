-- ==========================================================
-- BƯỚC 1: XÓA SẠCH DỮ LIỆU CŨ
-- ==========================================================
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE order_items;
TRUNCATE TABLE orders;
TRUNCATE TABLE product_images;
TRUNCATE TABLE product_variants;
TRUNCATE TABLE products;
TRUNCATE TABLE categories;
TRUNCATE TABLE brands;
TRUNCATE TABLE user_roles;
TRUNCATE TABLE users;
TRUNCATE TABLE addresses;
TRUNCATE TABLE reviews;
TRUNCATE TABLE cart_items;
TRUNCATE TABLE carts;
SET FOREIGN_KEY_CHECKS = 1;

-- ==========================================================
-- BƯỚC 2: USERS
-- ==========================================================
INSERT INTO users (id, email, password_hash, full_name, phone, status, email_verified, created_at, updated_at)
VALUES
(1, 'superadmin@ecommerce.com', '$2a$10$mB52p1s5eO4.G.lG/v.kXO.OT/5sWpIYISMO2i/m.b68.Q3g.D/Lq', 'Super Admin', '0900000001', 'active', true, NOW(), NOW()),
(2, 'manager@ecommerce.com', '$2a$10$mB52p1s5eO4.G.lG/v.kXO.OT/5sWpIYISMO2i/m.b68.Q3g.D/Lq', 'Quản lý', '0900000002', 'active', true, NOW(), NOW()),
(3, 'staff1@ecommerce.com', '$2a$10$mB52p1s5eO4.G.lG/v.kXO.OT/5sWpIYISMO2i/m.b68.Q3g.D/Lq', 'Nhân viên A', '0900000003', 'active', true, NOW(), NOW()),
(4, 'customer1@ecommerce.com', '$2a$10$mB52p1s5eO4.G.lG/v.kXO.OT/5sWpIYISMO2i/m.b68.Q3g.D/Lq', 'Nguyễn Văn A', '0912345678', 'active', true, NOW(), NOW()),
(5, 'customer2@ecommerce.com', '$2a$10$mB52p1s5eO4.G.lG/v.kXO.OT/5sWpIYISMO2i/m.b68.Q3g.D/Lq', 'Trần Thị B', '0912345679', 'active', true, NOW(), NOW());

-- ==========================================================
-- BƯỚC 3: USER_ROLES
-- ==========================================================
INSERT INTO user_roles (user_id, role)
VALUES
(1, 'SUPER_ADMIN'), (2, 'PRODUCT_MANAGER'), (3, 'ORDER_MANAGER'), (4, 'CUSTOMER'), (5, 'CUSTOMER');

-- ==========================================================
-- BƯỚC 4: BRANDS
-- ==========================================================
INSERT INTO brands (id, name, description, logo_url)
VALUES
(1, 'Nike', 'Thương hiệu thể thao hàng đầu thế giới', 'nike-logo.png'),
(2, 'Adidas', 'Thương hiệu thể thao Đức', 'adidas-logo.png'),
(3, 'Zara', 'Thời trang nhanh Tây Ban Nha', 'zara-logo.png'),
(4, 'Uniqlo', 'Thời trang Nhật Bản', 'uniqlo-logo.png');

-- ==========================================================
-- BƯỚC 5: CATEGORIES
-- ==========================================================
INSERT INTO categories (id, name, slug, description, parent_id, active, created_at, updated_at)
VALUES
(1, 'Áo Thun', 'ao-thun', 'Áo thun nam nữ', NULL, true, NOW(), NOW()),
(2, 'Quần Jeans', 'quan-jeans', 'Quần jeans thời trang', NULL, true, NOW(), NOW()),
(3, 'Giày Chạy Bộ', 'giay-chay-bo', 'Giày thể thao chạy bộ', NULL, true, NOW(), NOW()),
(4, 'Váy', 'vay', 'Váy nữ', NULL, true, NOW(), NOW());

-- ==========================================================
-- BƯỚC 6: PRODUCTS
-- ==========================================================
INSERT INTO products (id, name, slug, description, brand_id, category_id, default_image, created_at, updated_at)
VALUES
(1, 'Áo Thun Uniqlo AIRism Cổ Tròn', 'ao-thun-uniqlo-airism-co-tron', 'Áo thun thoáng khí', 4, 1, 'uniqlo-shirt.jpg', NOW(), NOW()),
(2, 'Quần Jeans Zara Slim Fit', 'quan-jeans-zara-slim-fit', 'Quần jeans slim', 3, 2, 'zara-jeans.jpg', NOW(), NOW()),
(3, 'Giày Chạy Bộ Nike Revolution 6', 'giay-chay-bo-nike-revolution-6', 'Giày chạy bộ Nike', 1, 3, 'nike-shoes.jpg', NOW(), NOW()),
(4, 'Váy Hoa Zara Mùa Hè', 'vay-hoa-zara-mua-he', 'Váy hoa mùa hè', 3, 4, 'zara-dress.jpg', NOW(), NOW()),
(5, 'Áo Hoodie Adidas Essentials', 'ao-hoodie-adidas-essentials', 'Áo hoodie Adidas', 2, 1, 'adidas-hoodie.jpg', NOW(), NOW()),
(6, 'Quần Tây Uniqlo Smart Ankle', 'quan-tay-uniqlo-smart-ankle', 'Quần tây Uniqlo', 4, 2, 'uniqlo-pants.jpg', NOW(), NOW()),
(7, 'Giày Adidas Ultraboost 22', 'giay-adidas-ultraboost-22', 'Giày Ultraboost', 2, 3, 'adidas-ultraboost.jpg', NOW(), NOW()),
(8, 'Áo Croptop Nữ Zara', 'ao-croptop-nu-zara', 'Áo croptop Zara', 3, 1, 'zara-croptop.jpg', NOW(), NOW()),
(9, 'Áo Thun Nike Pro', 'ao-thun-nike-pro', 'Áo thun Nike Pro', 1, 1, 'nike-pro.jpg', NOW(), NOW()),
(10, 'Quần Jeans Adidas', 'quan-jeans-adidas', 'Quần jeans Adidas', 2, 2, 'adidas-jeans.jpg', NOW(), NOW());

-- ==========================================================
-- BƯỚC 7: PRODUCT_VARIANTS
-- ==========================================================
INSERT INTO product_variants (id, product_id, sku, price, sale_price, stock_quantity, created_at, updated_at)
VALUES
(1, 1, 'UQ-AIR-BLK-M', 299000, NULL, 50, NOW(), NOW()),
(2, 2, 'ZARA-JEAN-BLU-30', 899000, NULL, 30, NOW(), NOW()),
(3, 3, 'NIKE-REV6-41', 1500000, NULL, 20, NOW(), NOW()),
(4, 4, 'ZARA-DRESS-S', 999000, NULL, 40, NOW(), NOW()),
(5, 5, 'ADI-HOOD-M', 1200000, NULL, 25, NOW(), NOW()),
(6, 6, 'UQ-PANT-S', 799000, NULL, 35, NOW(), NOW()),
(7, 7, 'ADI-UB-40', 3500000, NULL, 15, NOW(), NOW()),
(8, 8, 'ZARA-CROP-S', 499000, NULL, 45, NOW(), NOW()),
(9, 9, 'NIKE-PRO-M', 599000, NULL, 55, NOW(), NOW()),
(10, 10, 'ADI-JEANS-32', 999000, NULL, 28, NOW(), NOW());

-- ==========================================================
-- BƯỚC 8: PRODUCT_IMAGES
-- ==========================================================
INSERT INTO product_images (id, product_id, url, alt_text)
VALUES
(1, 1, 'uniqlo-shirt-1.jpg', 'Áo Uniqlo đen'),
(2, 2, 'zara-jeans-1.jpg', 'Quần Zara xanh');

-- ==========================================================
-- BƯỚC 9: ORDERS
-- ==========================================================
INSERT INTO orders (
<<<<<<< HEAD
    id, order_no, user_id, total_amount, final_amount,
=======
    id, order_no, user_id, total_amount, final_amount, 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
    order_code, status, customer_name, customer_phone,
    shipping_name, shipping_phone, shipping_address,  -- THÊM shipping_address
    shipping_address_line, shipping_city, shipping_district, shipping_province,
    order_status, pay_status, created_at, updated_at
) VALUES
<<<<<<< HEAD
(1, 'ORD-20251114-001', 4, 299000, 299000,
=======
(1, 'ORD-20251114-001', 4, 299000, 299000, 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
 'ORD-20251114-001', 'ACTIVE', 'Nguyễn Văn A', '0912345678',
 'Nguyễn Văn A', '0912345678', '123 Đường Láng, Hà Nội',  -- THÊM: shipping_address = shipping_address_line
 '123 Đường Láng, Hà Nội', 'Hà Nội', 'Đống Đa', 'Hà Nội',
 'Pending', 'Pending', NOW(), NOW()),
<<<<<<< HEAD
(2, 'ORD-20251114-002', 4, 899000, 899000,
=======
(2, 'ORD-20251114-002', 4, 899000, 899000, 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
 'ORD-20251114-002', 'ACTIVE', 'Nguyễn Văn A', '0912345678',
 'Nguyễn Văn A', '0912345678', '456 Lê Lợi, TP.HCM',
 '456 Lê Lợi, TP.HCM', 'TP.HCM', 'Quận 1', 'TP.HCM',
 'Pending', 'Pending', NOW(), NOW()),
<<<<<<< HEAD
(3, 'ORD-20251114-003', 4, 1500000, 1500000,
=======
(3, 'ORD-20251114-003', 4, 1500000, 1500000, 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
 'ORD-20251114-003', 'ACTIVE', 'Nguyễn Văn A', '0912345678',
 'Nguyễn Văn A', '0912345678', '789 Trần Phú, Đà Nẵng',
 '789 Trần Phú, Đà Nẵng', 'Đà Nẵng', 'Hải Châu', 'Đà Nẵng',
 'Pending', 'Pending', NOW(), NOW()),
<<<<<<< HEAD
(4, 'ORD-20251114-004', 4, 999000, 999000,
=======
(4, 'ORD-20251114-004', 4, 999000, 999000, 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
 'ORD-20251114-004', 'ACTIVE', 'Nguyễn Văn A', '0912345678',
 'Nguyễn Văn A', '0912345678', '101 Nguyễn Huệ, Huế',
 '101 Nguyễn Huệ, Huế', 'Thừa Thiên Huế', 'TP Huế', 'Thừa Thiên Huế',
 'Pending', 'Pending', NOW(), NOW());

-- ==========================================================
-- BƯỚC 10: ORDER_ITEMS
-- ==========================================================
INSERT INTO order_items (id, order_id, variant_id, product_name, variant_sku, unit_price, quantity, subtotal)
VALUES
(1, 1, 1, 'Áo Thun Uniqlo AIRism Cổ Tròn', 'UQ-AIR-BLK-M', 299000, 1, 299000),
(2, 2, 2, 'Quần Jeans Zara Slim Fit', 'ZARA-JEAN-BLU-30', 899000, 1, 899000),
(3, 3, 3, 'Giày Chạy Bộ Nike Revolution 6', 'NIKE-REV6-41', 1500000, 1, 1500000),
(4, 4, 4, 'Váy Hoa Zara Mùa Hè', 'ZARA-DRESS-S', 999000, 1, 999000);

-- ==========================================================
-- BƯỚC 11: WAREHOUSES – ĐÃ SỬA VALUES() → new.name
-- ==========================================================
INSERT INTO warehouses (id, name, location)
VALUES
(1, 'Kho Hà Nội', '123 Đường Láng, Hà Nội'),
(2, 'Kho TP.HCM', '456 Lê Lợi, Quận 1, TP.HCM'),
(3, 'Kho Đà Nẵng', '789 Trần Phú, Đà Nẵng')
AS new
ON DUPLICATE KEY UPDATE
    name = new.name,
    location = new.location;

-- ==========================================================
-- BƯỚC 12: INVENTORY – ĐÃ SỬA VALUES() → new.quantity
-- ==========================================================
INSERT INTO inventory (variant_id, warehouse_id, product_id, quantity, low_stock_threshold, last_updated)
VALUES
(1, 1, 1, 100, 10, NOW()),
(2, 1, 2, 150, 10, NOW()),
(3, 2, 3, 5, 10, NOW()),
(4, 2, 4, 8, 10, NOW())
AS new
ON DUPLICATE KEY UPDATE
    quantity = new.quantity,
    low_stock_threshold = new.low_stock_threshold,
    last_updated = NOW();
-- ==========================================================
-- BƯỚC 13: COUPON
-- ==========================================================
<<<<<<< HEAD
INSERT IGNORE INTO coupon
(id, code, type, value, min_order_value, start_date, end_date, usage_limit, used_count, active)
VALUES
=======
INSERT IGNORE INTO coupon 
(id, code, type, value, min_order_value, start_date, end_date, usage_limit, used_count, active) 
VALUES 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
(1, 'SALE10', 'PERCENT', 10.00, 500000.00, '2025-11-01 00:00:00', '2025-12-31 23:59:59', 100, 0, true),
(2, 'FREESHIP', 'FREE_SHIPPING', 0.00, 300000.00, '2025-11-01 00:00:00', '2025-12-31 23:59:59', 50, 0, true);

-- ==========================================================
-- BỔ SUNG CHỨC NĂNG ADMIN (KHÔNG CHỈNH SỬA PHẦN CŨ)
-- ==========================================================

-- 1. Thêm cột 2FA vào bảng users (chỉ thêm nếu chưa tồn tại)
SET @column_exists = (
<<<<<<< HEAD
    SELECT COUNT(*)
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = DATABASE()
      AND TABLE_NAME = 'users'
      AND COLUMN_NAME = 'two_factor_secret'
);

SET @sql = IF(@column_exists = 0,
    'ALTER TABLE users ADD COLUMN two_factor_secret VARCHAR(255) NULL',
=======
    SELECT COUNT(*) 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_SCHEMA = DATABASE() 
      AND TABLE_NAME = 'users' 
      AND COLUMN_NAME = 'two_factor_secret'
);

SET @sql = IF(@column_exists = 0, 
    'ALTER TABLE users ADD COLUMN two_factor_secret VARCHAR(255) NULL', 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
    'SELECT ''Column two_factor_secret already exists'' AS message'
);
PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

SET @column_exists = (
<<<<<<< HEAD
    SELECT COUNT(*)
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = DATABASE()
      AND TABLE_NAME = 'users'
      AND COLUMN_NAME = 'two_factor_enabled'
);

SET @sql = IF(@column_exists = 0,
    'ALTER TABLE users ADD COLUMN two_factor_enabled BOOLEAN DEFAULT FALSE',
=======
    SELECT COUNT(*) 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_SCHEMA = DATABASE() 
      AND TABLE_NAME = 'users' 
      AND COLUMN_NAME = 'two_factor_enabled'
);

SET @sql = IF(@column_exists = 0, 
    'ALTER TABLE users ADD COLUMN two_factor_enabled BOOLEAN DEFAULT FALSE', 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
    'SELECT ''Column two_factor_enabled already exists'' AS message'
);
PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- 2. Tạo bảng user_permissions (an toàn)
CREATE TABLE IF NOT EXISTS user_permissions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    permission VARCHAR(100) NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uniq_user_permission (user_id, permission)
);

-- 3. Trang tĩnh CMS
CREATE TABLE IF NOT EXISTS static_pages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    slug VARCHAR(100) UNIQUE NOT NULL,
    title VARCHAR(255),
    content TEXT,
    meta_title VARCHAR(255),
    meta_description TEXT,
    meta_keywords TEXT,
    og_image VARCHAR(255),
    published BOOLEAN DEFAULT FALSE,
    updated_by BIGINT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

-- 4. Banner / Slider
CREATE TABLE IF NOT EXISTS banners (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255),
    image_url VARCHAR(255),
    link VARCHAR(255),
    position INT DEFAULT 0,
    active BOOLEAN DEFAULT TRUE,
    start_date DATETIME,
    end_date DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 5. Blog / News
CREATE TABLE IF NOT EXISTS blog_posts (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255),
    slug VARCHAR(255) UNIQUE,
    excerpt TEXT,
    content TEXT,
    meta_title VARCHAR(255),
    meta_description TEXT,
    author_id BIGINT,
    published BOOLEAN DEFAULT FALSE,
    published_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (author_id) REFERENCES users(id)
);

-- 6. Mở rộng bảng reviews (thêm cột nếu chưa có)
SET @column_exists = (
<<<<<<< HEAD
    SELECT COUNT(*)
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = DATABASE()
      AND TABLE_NAME = 'reviews'
      AND COLUMN_NAME = 'approved'
);

SET @sql = IF(@column_exists = 0,
    'ALTER TABLE reviews
=======
    SELECT COUNT(*) 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_SCHEMA = DATABASE() 
      AND TABLE_NAME = 'reviews' 
      AND COLUMN_NAME = 'approved'
);

SET @sql = IF(@column_exists = 0, 
    'ALTER TABLE reviews 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
     ADD COLUMN approved BOOLEAN DEFAULT FALSE,
     ADD COLUMN hidden BOOLEAN DEFAULT FALSE,
     ADD COLUMN admin_reply TEXT,
     ADD COLUMN reviewed_by BIGINT,
     ADD COLUMN reviewed_at DATETIME,
<<<<<<< HEAD
     ADD FOREIGN KEY (reviewed_by) REFERENCES users(id)',
=======
     ADD FOREIGN KEY (reviewed_by) REFERENCES users(id)', 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
    'SELECT ''Review columns already exist'' AS message'
);
PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- 7. Báo cáo abuse
CREATE TABLE IF NOT EXISTS abuse_reports (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,
    entity_id BIGINT NOT NULL,
    reason TEXT,
    reporter_email VARCHAR(255),
    resolved BOOLEAN DEFAULT FALSE,
    resolved_by BIGINT,
    resolved_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (resolved_by) REFERENCES users(id)
);

-- 8. Cấu hình hệ thống
CREATE TABLE IF NOT EXISTS system_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    updated_by BIGINT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

-- 9. Audit logs
CREATE TABLE IF NOT EXISTS audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    action VARCHAR(100),
    entity_type VARCHAR(50),
    entity_id BIGINT,
    details TEXT,
    ip_address VARCHAR(45),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 10. Bổ sung quyền mẫu cho Super Admin (nếu chưa có)
<<<<<<< HEAD
INSERT IGNORE INTO user_permissions (user_id, permission)
=======
INSERT IGNORE INTO user_permissions (user_id, permission) 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
SELECT 1, 'CMS_PAGE_WRITE' WHERE NOT EXISTS (
    SELECT 1 FROM user_permissions WHERE user_id = 1 AND permission = 'CMS_PAGE_WRITE'
);

<<<<<<< HEAD
INSERT IGNORE INTO user_permissions (user_id, permission)
=======
INSERT IGNORE INTO user_permissions (user_id, permission) 
>>>>>>> b332b90e2796b2d564ff0c65f80141d694ab4a22
SELECT 1, 'REVIEW_APPROVE' WHERE NOT EXISTS (
    SELECT 1 FROM user_permissions WHERE user_id = 1 AND permission = 'REVIEW_APPROVE'
);